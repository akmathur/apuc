<div class="photo-widget-container" id="photo-<%= profile.id %>" data-profile="<%= profile.id %>">
  <%= form_for(profile,
              :remote => true,
              :url => update_crop_profile_path(profile)) do |f| %>
    <h2>Crop picture:</h2>
    <fieldset>
      <%= image_tag profile.avatar.url(:normal), :id => "cropbox-#{profile.id}" %>

      <%= f.text_field :crop, :id => 'crop', :size => 2, :class => "visible" %>
      <%= f.text_field :crop_x, :id => 'crop_x', :size => 2, :class => "visible" %>
      <%= f.text_field :crop_y, :id => 'crop_y', :size => 2, :class => "visible" %>
      <%= f.text_field :crop_w, :id => 'crop_w', :size => 2, :class => "visible" %>
      <%= f.text_field :crop_h, :id => 'crop_h', :size => 2, :class => "visible" %>

      <br />
      <%= submit_tag 'crop now' %>
    </fieldset>
  <% end %>
</div>

<script type="text/javascript">
  function showPreview(coords){
    	var ratio = <%= profile.avatar_geometry(:original).width / profile.avatar_geometry(:normal).width %>;

      $('#crop_x').val(Math.round(coords.x * ratio));
      $('#crop_y').val(Math.round(coords.y * ratio));
      $('#crop_w').val(Math.round(coords.w * ratio));
      $('#crop_h').val(Math.round(coords.h * ratio));
  }

  $(function(){
      $('#' + '<%= "cropbox-#{profile.id}" %>').Jcrop({
          onSelect: showPreview,
          onChange: showPreview,
          setSelect: [ 0, 0, <%= Profile::AVATAR_NW %>, <%= Profile::AVATAR_NH %> ],
          aspectRatio: <%= Profile::AVATAR_NW %>/<%= Profile::AVATAR_NH %>
      });
  });
</script>
